package no.nav.tpt.infrastructure.vulnerability

import kotlinx.coroutines.runBlocking
import no.nav.tpt.domain.vulnerability.*
import java.time.DayOfWeek
import java.time.Instant
import java.time.LocalDateTime
import java.time.ZoneId
import java.time.temporal.ChronoUnit
import kotlin.test.*

class VulnerabilitySearchServiceTest {

    @Test
    fun `should return paginated search results`() = runBlocking {
        val repository = MockSearchRepository(
            results = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "CRITICAL"),
                createSearchResult("CVE-2024-2", "team-a", "app-2", "HIGH"),
                createSearchResult("CVE-2024-3", "team-b", "app-3", "MEDIUM")
            ),
            totalCount = 3
        )
        val service = VulnerabilitySearchService(repository)

        val request = VulnerabilitySearchRequest(
            page = 1,
            pageSize = 10
        )

        val response = service.searchVulnerabilities(request)

        assertEquals(3, response.totalCount)
        assertEquals(1, response.page)
        assertEquals(10, response.pageSize)
        assertEquals(3, response.items.size)
    }

    @Test
    fun `should calculate SLA status for critical vulnerabilities`() = runBlocking {
        val now = Instant.now()
        val overdueDiscoveredAt = subtractWorkdays(now, 3)
        val withinSlaDiscoveredAt = now.minus(12, ChronoUnit.HOURS)

        val repository = MockSearchRepository(
            results = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "CRITICAL", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-2", "team-a", "app-2", "CRITICAL", discoveredAt = withinSlaDiscoveredAt)
            ),
            totalCount = 2
        )
        val service = VulnerabilitySearchService(repository)

        val request = VulnerabilitySearchRequest(page = 1, pageSize = 10)
        val response = service.searchVulnerabilities(request)

        assertEquals("OVERDUE", response.items[0].slaStatus)
        assertEquals("WITHIN_SLA", response.items[1].slaStatus)
    }

    @Test
    fun `should calculate SLA status for non-critical vulnerabilities`() = runBlocking {
        val now = Instant.now()
        val overdueDiscoveredAt = now.minus(35, ChronoUnit.DAYS)
        val dueSoonDiscoveredAt = now.minus(25, ChronoUnit.DAYS)
        val withinSlaDiscoveredAt = now.minus(10, ChronoUnit.DAYS)

        val repository = MockSearchRepository(
            results = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "HIGH", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-2", "team-a", "app-2", "MEDIUM", discoveredAt = dueSoonDiscoveredAt),
                createSearchResult("CVE-2024-3", "team-a", "app-3", "LOW", discoveredAt = withinSlaDiscoveredAt)
            ),
            totalCount = 3
        )
        val service = VulnerabilitySearchService(repository)

        val request = VulnerabilitySearchRequest(page = 1, pageSize = 10)
        val response = service.searchVulnerabilities(request)

        assertEquals("OVERDUE", response.items[0].slaStatus)
        assertEquals("DUE_SOON", response.items[1].slaStatus)
        assertEquals("WITHIN_SLA", response.items[2].slaStatus)
    }

    @Test
    fun `should return empty report when no teams provided`() = runBlocking {
        val repository = MockSearchRepository()
        val service = VulnerabilitySearchService(repository)

        val response = service.getOverdueSlaReport(emptyList())

        assertEquals(0, response.totalOverdue)
        assertEquals(0, response.teams.size)
    }

    @Test
    fun `should calculate overdue report for critical vulnerabilities`() = runBlocking {
        val now = Instant.now()
        val overdueDiscoveredAt = subtractWorkdays(now, 3)

        val repository = MockSearchRepository(
            activeVulnerabilities = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "CRITICAL", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-2", "team-a", "app-2", "CRITICAL", discoveredAt = now.minus(12, ChronoUnit.HOURS))
            )
        )
        val service = VulnerabilitySearchService(repository)

        val response = service.getOverdueSlaReport(listOf("team-a"))

        assertEquals(1, response.totalOverdue)
        assertEquals(1, response.teams.size)
        
        val teamStatus = response.teams[0]
        assertEquals("team-a", teamStatus.teamSlug)
        assertEquals(1, teamStatus.criticalOverdue)
        assertEquals(1, teamStatus.criticalWithinSla)
        assertEquals(0, teamStatus.nonCriticalOverdue)
        assertNotNull(teamStatus.criticalOverdueItems)
        assertEquals(1, teamStatus.criticalOverdueItems!!.size)
        assertEquals("CVE-2024-1", teamStatus.criticalOverdueItems!![0].cveId)
        assertNotNull(teamStatus.criticalOverdueItems!![0].workdaysOverdue)
    }

    @Test
    fun `should calculate overdue report for non-critical vulnerabilities`() = runBlocking {
        val now = Instant.now()
        val overdueDiscoveredAt = now.minus(35, ChronoUnit.DAYS)

        val repository = MockSearchRepository(
            activeVulnerabilities = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "HIGH", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-2", "team-a", "app-2", "MEDIUM", discoveredAt = now.minus(10, ChronoUnit.DAYS))
            )
        )
        val service = VulnerabilitySearchService(repository)

        val response = service.getOverdueSlaReport(listOf("team-a"))

        assertEquals(1, response.totalOverdue)
        
        val teamStatus = response.teams[0]
        assertEquals(1, teamStatus.nonCriticalOverdue)
        assertEquals(1, teamStatus.nonCriticalWithinSla)
        assertNotNull(teamStatus.nonCriticalOverdueItems)
        assertEquals(1, teamStatus.nonCriticalOverdueItems!!.size)
        assertNull(teamStatus.nonCriticalOverdueItems!![0].workdaysOverdue)
    }

    @Test
    fun `should group vulnerabilities by team in overdue report`() = runBlocking {
        val now = Instant.now()
        val overdueDiscoveredAt = now.minus(35, ChronoUnit.DAYS)

        val repository = MockSearchRepository(
            activeVulnerabilities = listOf(
                createSearchResult("CVE-2024-1", "team-a", "app-1", "HIGH", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-2", "team-b", "app-2", "HIGH", discoveredAt = overdueDiscoveredAt),
                createSearchResult("CVE-2024-3", "team-a", "app-3", "MEDIUM", discoveredAt = now.minus(10, ChronoUnit.DAYS))
            )
        )
        val service = VulnerabilitySearchService(repository)

        val response = service.getOverdueSlaReport(listOf("team-a", "team-b"))

        assertEquals(2, response.totalOverdue)
        assertEquals(2, response.teams.size)
        
        val teamAStatus = response.teams.find { it.teamSlug == "team-a" }
        assertNotNull(teamAStatus)
        assertEquals(1, teamAStatus.nonCriticalOverdue)
        assertEquals(2, teamAStatus.totalVulnerabilities)
    }

    @Test
    fun `should pass correct offset and limit to repository`() = runBlocking {
        val repository = MockSearchRepository(results = emptyList(), totalCount = 0)
        val service = VulnerabilitySearchService(repository)

        service.searchVulnerabilities(VulnerabilitySearchRequest(page = 3, pageSize = 25))

        assertEquals(50, repository.lastOffset)
        assertEquals(25, repository.lastLimit)
    }

    private fun createSearchResult(
        cveId: String,
        teamSlug: String,
        appName: String,
        severity: String,
        discoveredAt: Instant = Instant.now().minus(5, ChronoUnit.DAYS)
    ): VulnerabilitySearchResult {
        return VulnerabilitySearchResult(
            cveId = cveId,
            teamSlug = teamSlug,
            applicationName = appName,
            applicationNaisId = "$appName-id",
            workloadType = "NAIS_APPLICATION",
            environment = "prod",
            packageName = "test-package",
            severity = severity,
            hasExternalIngress = false,
            suppressed = false,
            discoveredAt = discoveredAt,
            lastSeenAt = Instant.now()
        )
    }

    private fun subtractWorkdays(from: Instant, workdays: Int): Instant {
        val zoneId = ZoneId.of("Europe/Oslo")
        var current = LocalDateTime.ofInstant(from, zoneId)
        var remaining = workdays

        while (remaining > 0) {
            current = current.minusDays(1)
            if (current.dayOfWeek != DayOfWeek.SATURDAY && current.dayOfWeek != DayOfWeek.SUNDAY) {
                remaining--
            }
        }

        return current.atZone(zoneId).toInstant()
    }
}

class MockSearchRepository(
    private val results: List<VulnerabilitySearchResult> = emptyList(),
    private val totalCount: Int = 0,
    private val activeVulnerabilities: List<VulnerabilitySearchResult> = emptyList()
) : VulnerabilityRepository {
    var lastOffset: Int = 0
    var lastLimit: Int = 0

    override suspend fun upsertVulnerability(data: VulnerabilityTrackingData): VulnerabilityTrackingData {
        throw NotImplementedError()
    }

    override suspend fun searchVulnerabilities(
        cveId: String?,
        teamSlug: String?,
        severities: List<String>?,
        hasExternalIngress: Boolean?,
        suppressed: Boolean?,
        limit: Int,
        offset: Int
    ): Pair<List<VulnerabilitySearchResult>, Int> {
        lastOffset = offset
        lastLimit = limit
        return Pair(results, totalCount)
    }

    override suspend fun getActiveVulnerabilitiesForTeams(
        teamSlugs: List<String>
    ): List<VulnerabilitySearchResult> {
        return activeVulnerabilities
    }

    override suspend fun deleteOldDataForTeam(teamSlug: String, currentSyncTime: Instant): Int {
        throw NotImplementedError()
    }
}
