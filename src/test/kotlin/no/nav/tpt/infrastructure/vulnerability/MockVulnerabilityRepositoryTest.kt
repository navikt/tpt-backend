package no.nav.tpt.infrastructure.vulnerability

import kotlinx.coroutines.runBlocking
import kotlin.test.Test
import kotlin.test.assertEquals

class MockVulnerabilityRepositoryTest {
    
    @Test
    fun `withSampleData should return team vulnerability counts`() = runBlocking {
        val repo = MockVulnerabilityRepository.withSampleData()
        
        val counts = repo.getTeamVulnerabilityCounts()
        
        assertEquals(3, counts.size, "Should have 3 teams")
        assertEquals(45, counts.find { it.teamSlug == "team-lokal-utvikler" }?.totalCount)
        assertEquals(32, counts.find { it.teamSlug == "team-b" }?.totalCount)
        assertEquals(18, counts.find { it.teamSlug == "team-c" }?.totalCount)
    }
    
    @Test
    fun `withSampleData should return SLA summaries`() = runBlocking {
        val repo = MockVulnerabilityRepository.withSampleData()
        
        val summaries = repo.getTeamSlaSummaries()
        
        assertEquals(3, summaries.size, "Should have 3 teams")
        
        val teamA = summaries.find { it.teamSlug == "team-lokal-utvikler" }!!
        assertEquals(45, teamA.totalVulnerabilities)
        assertEquals(3, teamA.criticalOverdue)
        assertEquals(5, teamA.repositoriesOutOfSla)
    }
    
    @Test
    fun `withSampleData should return SLA details for requested teams`() = runBlocking {
        val repo = MockVulnerabilityRepository.withSampleData()
        
        val details = repo.getTeamSlaDetails(listOf("team-lokal-utvikler", "team-b"))
        
        assertEquals(2, details.size, "Should have details for 2 teams")
        
        val teamA = details.find { it.teamSlug == "team-lokal-utvikler" }!!
        assertEquals(3, teamA.criticalOverdueItems.size)
        assertEquals(2, teamA.nonCriticalOverdueItems.size)
    }
    
    @Test
    fun `empty constructor should return empty lists`() = runBlocking {
        val repo = MockVulnerabilityRepository()
        
        assertEquals(0, repo.getTeamVulnerabilityCounts().size)
        assertEquals(0, repo.getTeamSlaSummaries().size)
        assertEquals(0, repo.getTeamSlaDetails(listOf("team-lokal-utvikler")).size)
    }
}
