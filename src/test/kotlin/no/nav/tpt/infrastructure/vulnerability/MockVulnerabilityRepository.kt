package no.nav.tpt.infrastructure.vulnerability

import no.nav.tpt.domain.vulnerability.*
import java.time.Instant

class MockVulnerabilityRepository(
    private val vulnerabilities: List<VulnerabilitySearchResult> = emptyList(),
    private val teamVulnerabilityCounts: List<TeamVulnerabilityCount> = emptyList(),
    private val teamSlaSummaries: List<TeamSlaSummary> = emptyList(),
    private val teamSlaDetails: Map<String, TeamSlaDetails> = emptyMap(),
    private val throwException: Boolean = false,
    private val failOnCveId: String? = null
) : VulnerabilityRepository {
    
    var upsertCount = 0
    var deleteOldDataCount = 0
    var getActiveVulnerabilitiesCalled = false
    var lastTeamSlugs: List<String>? = null
    
    private val upsertedVulnerabilities = mutableListOf<VulnerabilityTrackingData>()
    private val syncedData = mutableListOf<VulnerabilitySearchResult>()
    private val teamSyncMetadata = mutableMapOf<String, Instant>()
    
    override suspend fun upsertVulnerability(vulnerability: VulnerabilityTrackingData): VulnerabilityTrackingData {
        if (vulnerability.cveId == failOnCveId) {
            throw RuntimeException("Simulated database error for CVE $failOnCveId")
        }
        upsertCount++
        upsertedVulnerabilities.add(vulnerability)
        
        syncedData.add(VulnerabilitySearchResult(
            cveId = vulnerability.cveId,
            teamSlug = vulnerability.teamSlug,
            applicationName = vulnerability.appName,
            applicationNaisId = vulnerability.appNaisId,
            workloadType = vulnerability.appWorkloadType,
            environment = vulnerability.appEnvironment,
            repository = vulnerability.appRepository,
            imageTag = vulnerability.appImageTag,
            ingressTypes = vulnerability.appIngressTypes,
            packageName = vulnerability.packageName,
            severity = vulnerability.severity,
            description = vulnerability.description,
            vulnerabilityDetailsLink = vulnerability.vulnerabilityDetailsLink,
            hasExternalIngress = vulnerability.appHasExternalIngress,
            suppressed = vulnerability.suppressed,
            discoveredAt = vulnerability.discoveredAt,
            lastSeenAt = vulnerability.lastSeenAt
        ))
        return vulnerability
    }
    
    override suspend fun batchUpsertVulnerabilities(vulnerabilities: List<VulnerabilityTrackingData>): Int {
        var count = 0
        for (vuln in vulnerabilities) {
            try {
                upsertVulnerability(vuln)
                count++
            } catch (e: Exception) {
                // skip failed items, matching production error behaviour expectations in tests
            }
        }
        return count
    }

    override suspend fun getActiveVulnerabilitiesForTeams(teamSlugs: List<String>): List<VulnerabilitySearchResult> {
        getActiveVulnerabilitiesCalled = true
        lastTeamSlugs = teamSlugs
        if (throwException) {
            throw RuntimeException("Simulated database connection failure")
        }
        val allData = (vulnerabilities + syncedData).filter { it.teamSlug in teamSlugs }
        return allData
    }
    
    override suspend fun deleteOldDataForTeam(teamSlug: String, beforeTimestamp: Instant): Int {
        deleteOldDataCount++
        
        val toDelete = upsertedVulnerabilities.filter { 
            it.teamSlug == teamSlug && it.syncTimestamp.isBefore(beforeTimestamp)
        }
        val deletedCount = toDelete.size
        
        upsertedVulnerabilities.removeAll(toDelete)
        
        val remainingCveIds = upsertedVulnerabilities.map { it.cveId }.toSet()
        syncedData.removeIf { it.cveId !in remainingCveIds }
        
        return deletedCount
    }
    
    override suspend fun getTeamVulnerabilityCounts() = teamVulnerabilityCounts
    
    override suspend fun getTeamSlaSummaries() = teamSlaSummaries
    
    override suspend fun getTeamSlaDetails(teamSlugs: List<String>) = 
        teamSlugs.mapNotNull { teamSlaDetails[it] }
    
    override suspend fun updateTeamSyncMetadata(teamSlug: String, syncTime: Instant) {
        teamSyncMetadata[teamSlug] = syncTime
    }
    
    override suspend fun getTeamLastSyncTime(teamSlug: String): Instant? {
        return teamSyncMetadata[teamSlug]
    }
    
    override suspend fun getTeamsNeedingSync(teamSlugs: List<String>, olderThan: Instant): List<String> {
        return teamSlugs.filter { teamSlug ->
            val lastSync = teamSyncMetadata[teamSlug]
            lastSync == null || lastSync.isBefore(olderThan)
        }
    }
    
    fun getUpsertedVulnerabilities() = upsertedVulnerabilities.toList()

    
    companion object {
        fun withSampleData() = MockVulnerabilityRepository(
            teamVulnerabilityCounts = listOf(
                TeamVulnerabilityCount(
                    teamSlug = "team-lokal-utvikler",
                    totalCount = 45,
                    criticalCount = 7,
                    highCount = 15,
                    mediumCount = 18,
                    lowCount = 5,
                    unknownCount = 0
                ),
                TeamVulnerabilityCount(
                    teamSlug = "team-b",
                    totalCount = 32,
                    criticalCount = 4,
                    highCount = 10,
                    mediumCount = 14,
                    lowCount = 4,
                    unknownCount = 0
                ),
                TeamVulnerabilityCount(
                    teamSlug = "team-c",
                    totalCount = 18,
                    criticalCount = 1,
                    highCount = 5,
                    mediumCount = 10,
                    lowCount = 2,
                    unknownCount = 0
                )
            ),
            teamSlaSummaries = listOf(
                TeamSlaSummary(
                    teamSlug = "team-lokal-utvikler",
                    totalVulnerabilities = 45,
                    criticalOverdue = 5,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 13,
                    nonCriticalWithinSla = 25,
                    repositoriesOutOfSla = 6,
                    maxDaysOverdue = 92
                ),
                TeamSlaSummary(
                    teamSlug = "team-b",
                    totalVulnerabilities = 32,
                    criticalOverdue = 2,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 9,
                    nonCriticalWithinSla = 19,
                    repositoriesOutOfSla = 4,
                    maxDaysOverdue = 68
                ),
                TeamSlaSummary(
                    teamSlug = "team-c",
                    totalVulnerabilities = 18,
                    criticalOverdue = 0,
                    criticalWithinSla = 1,
                    nonCriticalOverdue = 4,
                    nonCriticalWithinSla = 13,
                    repositoriesOutOfSla = 2,
                    maxDaysOverdue = 15
                )
            ),
            teamSlaDetails = mapOf(
                "team-lokal-utvikler" to TeamSlaDetails(
                    teamSlug = "team-lokal-utvikler",
                    totalVulnerabilities = 45,
                    criticalOverdue = 5,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 13,
                    nonCriticalWithinSla = 25,
                    repositoriesOutOfSla = 6,
                    maxDaysOverdue = 92,
                    criticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2023-9999",
                            applicationName = "legacy-app",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(95)),
                            daysOverdue = 92
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-1234",
                            applicationName = "my-app",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(50)),
                            daysOverdue = 45
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-5678",
                            applicationName = "another-app",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(10)),
                            daysOverdue = 8
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2025-1111",
                            applicationName = "backend-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(5)),
                            daysOverdue = 3
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2025-2222",
                            applicationName = "api-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(3)),
                            daysOverdue = 2
                        )
                    ),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2023-8888",
                            applicationName = "old-frontend",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(125)),
                            daysOverdue = 95
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2023-7777",
                            applicationName = "legacy-api",
                            severity = "MEDIUM",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(100)),
                            daysOverdue = 70
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-3456",
                            applicationName = "frontend-app",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(45)),
                            daysOverdue = 15
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-7890",
                            applicationName = "api-gateway",
                            severity = "MEDIUM",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(40)),
                            daysOverdue = 10
                        )
                    )
                ),
                "team-b" to TeamSlaDetails(
                    teamSlug = "team-b",
                    totalVulnerabilities = 32,
                    criticalOverdue = 2,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 9,
                    nonCriticalWithinSla = 19,
                    repositoriesOutOfSla = 4,
                    maxDaysOverdue = 68,
                    criticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-1111",
                            applicationName = "payment-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(32)),
                            daysOverdue = 30
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2025-3333",
                            applicationName = "checkout-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(4)),
                            daysOverdue = 2
                        )
                    ),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2023-6666",
                            applicationName = "legacy-payment",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(98)),
                            daysOverdue = 68
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-2222",
                            applicationName = "auth-service",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(35)),
                            daysOverdue = 5
                        )
                    )
                ),
                "team-c" to TeamSlaDetails(
                    teamSlug = "team-c",
                    totalVulnerabilities = 18,
                    criticalOverdue = 0,
                    criticalWithinSla = 1,
                    nonCriticalOverdue = 4,
                    nonCriticalWithinSla = 13,
                    repositoriesOutOfSla = 2,
                    maxDaysOverdue = 15,
                    criticalOverdueItems = emptyList(),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-3333",
                            applicationName = "logging-service",
                            severity = "MEDIUM",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(45)),
                            daysOverdue = 15
                        )
                    )
                )
            )
        )
    }
}
