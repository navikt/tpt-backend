package no.nav.tpt.infrastructure.vulnerability

import no.nav.tpt.domain.vulnerability.*
import java.time.Instant

class MockVulnerabilityRepository(
    private val teamVulnerabilityCounts: List<TeamVulnerabilityCount> = emptyList(),
    private val teamSlaSummaries: List<TeamSlaSummary> = emptyList(),
    private val teamSlaDetails: Map<String, TeamSlaDetails> = emptyMap()
) : VulnerabilityRepository {
    
    override suspend fun upsertVulnerability(vulnerability: VulnerabilityTrackingData) = vulnerability
    
    override suspend fun getActiveVulnerabilitiesForTeams(teamSlugs: List<String>) = emptyList<VulnerabilitySearchResult>()
    
    override suspend fun deleteOldDataForTeam(teamSlug: String, beforeTimestamp: Instant) = 0
    
    override suspend fun getTeamVulnerabilityCounts() = teamVulnerabilityCounts
    
    override suspend fun getTeamSlaSummaries() = teamSlaSummaries
    
    override suspend fun getTeamSlaDetails(teamSlugs: List<String>) = 
        teamSlugs.mapNotNull { teamSlaDetails[it] }
    
    companion object {
        fun withSampleData() = MockVulnerabilityRepository(
            teamVulnerabilityCounts = listOf(
                TeamVulnerabilityCount(
                    teamSlug = "team-lokal-utvikler",
                    totalCount = 45,
                    criticalCount = 5,
                    highCount = 15,
                    mediumCount = 20,
                    lowCount = 5,
                    unknownCount = 0
                ),
                TeamVulnerabilityCount(
                    teamSlug = "team-b",
                    totalCount = 32,
                    criticalCount = 3,
                    highCount = 10,
                    mediumCount = 15,
                    lowCount = 4,
                    unknownCount = 0
                ),
                TeamVulnerabilityCount(
                    teamSlug = "team-c",
                    totalCount = 18,
                    criticalCount = 1,
                    highCount = 5,
                    mediumCount = 10,
                    lowCount = 2,
                    unknownCount = 0
                )
            ),
            teamSlaSummaries = listOf(
                TeamSlaSummary(
                    teamSlug = "team-lokal-utvikler",
                    totalVulnerabilities = 45,
                    criticalOverdue = 3,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 12,
                    nonCriticalWithinSla = 28,
                    repositoriesOutOfSla = 5,
                    maxDaysOverdue = 45
                ),
                TeamSlaSummary(
                    teamSlug = "team-b",
                    totalVulnerabilities = 32,
                    criticalOverdue = 1,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 8,
                    nonCriticalWithinSla = 21,
                    repositoriesOutOfSla = 3,
                    maxDaysOverdue = 30
                ),
                TeamSlaSummary(
                    teamSlug = "team-c",
                    totalVulnerabilities = 18,
                    criticalOverdue = 0,
                    criticalWithinSla = 1,
                    nonCriticalOverdue = 4,
                    nonCriticalWithinSla = 13,
                    repositoriesOutOfSla = 2,
                    maxDaysOverdue = 15
                )
            ),
            teamSlaDetails = mapOf(
                "team-lokal-utvikler" to TeamSlaDetails(
                    teamSlug = "team-lokal-utvikler",
                    totalVulnerabilities = 45,
                    criticalOverdue = 3,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 12,
                    nonCriticalWithinSla = 28,
                    repositoriesOutOfSla = 5,
                    maxDaysOverdue = 45,
                    criticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-1234",
                            applicationName = "my-app",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(50)),
                            daysOverdue = 45
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-5678",
                            applicationName = "another-app",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(10)),
                            daysOverdue = 8
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-9012",
                            applicationName = "backend-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(5)),
                            daysOverdue = 3
                        )
                    ),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-3456",
                            applicationName = "frontend-app",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(45)),
                            daysOverdue = 15
                        ),
                        SlaOverdueItem(
                            cveId = "CVE-2024-7890",
                            applicationName = "api-gateway",
                            severity = "MEDIUM",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(40)),
                            daysOverdue = 10
                        )
                    )
                ),
                "team-b" to TeamSlaDetails(
                    teamSlug = "team-b",
                    totalVulnerabilities = 32,
                    criticalOverdue = 1,
                    criticalWithinSla = 2,
                    nonCriticalOverdue = 8,
                    nonCriticalWithinSla = 21,
                    repositoriesOutOfSla = 3,
                    maxDaysOverdue = 30,
                    criticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-1111",
                            applicationName = "payment-service",
                            severity = "CRITICAL",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(32)),
                            daysOverdue = 30
                        )
                    ),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-2222",
                            applicationName = "auth-service",
                            severity = "HIGH",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(35)),
                            daysOverdue = 5
                        )
                    )
                ),
                "team-c" to TeamSlaDetails(
                    teamSlug = "team-c",
                    totalVulnerabilities = 18,
                    criticalOverdue = 0,
                    criticalWithinSla = 1,
                    nonCriticalOverdue = 4,
                    nonCriticalWithinSla = 13,
                    repositoriesOutOfSla = 2,
                    maxDaysOverdue = 15,
                    criticalOverdueItems = emptyList(),
                    nonCriticalOverdueItems = listOf(
                        SlaOverdueItem(
                            cveId = "CVE-2024-3333",
                            applicationName = "logging-service",
                            severity = "MEDIUM",
                            discoveredAt = Instant.now().minus(java.time.Duration.ofDays(45)),
                            daysOverdue = 15
                        )
                    )
                )
            )
        )
    }
}
