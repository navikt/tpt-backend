package no.nav.tpt.routes

import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.http.*
import io.ktor.server.testing.*
import kotlinx.serialization.json.Json
import no.nav.tpt.domain.vulnerability.*
import no.nav.tpt.infrastructure.auth.MockTokenIntrospectionService
import no.nav.tpt.plugins.testModule
import kotlin.test.*

class VulnerabilitySearchRoutesTest {

    @Test
    fun `should return 401 when no authorization header provided for SLA report`() = testApplication {
        application { testModule() }

        val response = client.get("/sla/overdue")

        assertEquals(HttpStatusCode.Unauthorized, response.status)
    }

    @Test
    fun `should return SLA report for user's teams`() = testApplication {
        val tokenIntrospectionService = MockTokenIntrospectionService(
            shouldSucceed = true,
            navIdent = "test-ident",
            preferredUsername = "test@example.com"
        )

        application {
            testModule(tokenIntrospectionService)
        }

        val response = client.get("/sla/overdue") {
            header(HttpHeaders.Authorization, "Bearer valid-token")
        }

        assertEquals(HttpStatusCode.OK, response.status)
        assertEquals(ContentType.Application.Json, response.contentType()?.withoutParameters())

        val slaResponse = Json.decodeFromString<SlaOverdueResponse>(response.bodyAsText())
        assertNotNull(slaResponse)
        assertNotNull(slaResponse.generatedAt)
    }

    @Test
    fun `should return SLA report with repository statistics`() = testApplication {
        val tokenIntrospectionService = MockTokenIntrospectionService(
            shouldSucceed = true,
            navIdent = "test-ident",
            preferredUsername = "test@example.com"
        )

        application {
            testModule(tokenIntrospectionService)
        }

        val response = client.get("/sla/overdue") {
            header(HttpHeaders.Authorization, "Bearer valid-token")
        }

        assertEquals(HttpStatusCode.OK, response.status)
        
        val slaResponse = Json.decodeFromString<SlaOverdueResponse>(response.bodyAsText())
        // Verify new fields exist in response
        slaResponse.teams.forEach { team ->
            assertNotNull(team.repositoriesOutOfSla)
            assertNotNull(team.maxDaysOverdue)
        }
    }
}
