-- Vulnerability Tracking Table
-- Single denormalized table for fast queries without JOINs
CREATE TABLE vulnerability_tracking (
    id SERIAL PRIMARY KEY,
    
    -- Team context
    team_slug VARCHAR(100) NOT NULL,
    team_slack_channel VARCHAR(100),
    
    -- Application context
    app_nais_id VARCHAR(255) NOT NULL,
    app_name VARCHAR(255) NOT NULL,
    app_workload_type VARCHAR(20) NOT NULL,
    app_environment VARCHAR(100),
    app_repository VARCHAR(500),
    app_image_name VARCHAR(500),
    app_image_tag VARCHAR(255),
    app_has_external_ingress BOOLEAN DEFAULT FALSE,
    app_ingress_types JSONB,
    
    -- Vulnerability data
    cve_id VARCHAR(20) NOT NULL,
    package_name VARCHAR(255),
    severity VARCHAR(20),
    description TEXT,
    vulnerability_details_link TEXT,
    suppressed BOOLEAN DEFAULT FALSE,
    
    -- Timestamps for SLA tracking
    discovered_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_seen_at TIMESTAMP NOT NULL DEFAULT NOW(),
    resolved_at TIMESTAMP,
    sync_timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(app_nais_id, cve_id, package_name)
);

-- Primary query indexes
CREATE INDEX idx_vt_team_slug ON vulnerability_tracking(team_slug);
CREATE INDEX idx_vt_app_name ON vulnerability_tracking(app_name);
CREATE INDEX idx_vt_cve_id ON vulnerability_tracking(cve_id);

-- SLA tracking indexes
CREATE INDEX idx_vt_active_vulns ON vulnerability_tracking(resolved_at) WHERE resolved_at IS NULL;
CREATE INDEX idx_vt_discovered_at ON vulnerability_tracking(discovered_at DESC);
CREATE INDEX idx_vt_sla_critical ON vulnerability_tracking(team_slug, discovered_at, severity) 
    WHERE resolved_at IS NULL AND suppressed = FALSE AND severity = 'CRITICAL';
CREATE INDEX idx_vt_sla_other ON vulnerability_tracking(team_slug, discovered_at, severity) 
    WHERE resolved_at IS NULL AND suppressed = FALSE AND severity IN ('HIGH', 'MEDIUM', 'LOW', 'UNKNOWN');

-- Search and filter indexes
CREATE INDEX idx_vt_severity ON vulnerability_tracking(severity);
CREATE INDEX idx_vt_external_ingress ON vulnerability_tracking(app_has_external_ingress) 
    WHERE app_has_external_ingress = TRUE;
CREATE INDEX idx_vt_suppressed ON vulnerability_tracking(suppressed);

-- Sync cleanup index
CREATE INDEX idx_vt_sync_cleanup ON vulnerability_tracking(team_slug, sync_timestamp);

COMMENT ON TABLE vulnerability_tracking IS 'Denormalized vulnerability tracking with team/app/cve context for fast queries without JOINs';
COMMENT ON COLUMN vulnerability_tracking.sync_timestamp IS 'Timestamp when this row was last synced - used for cleanup of deleted teams/apps';
COMMENT ON COLUMN vulnerability_tracking.discovered_at IS 'First time this CVE was seen on this app (for SLA tracking)';
COMMENT ON COLUMN vulnerability_tracking.last_seen_at IS 'Most recent sync where this CVE was present';
COMMENT ON COLUMN vulnerability_tracking.resolved_at IS 'When CVE was resolved (NULL = still active)';
