-- CVEs Table
-- Reference data for CVEs (stored once per unique CVE)
CREATE TABLE cves (
    id VARCHAR(20) PRIMARY KEY,
    severity VARCHAR(20),
    description TEXT,
    vulnerability_details_link TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

COMMENT ON TABLE cves IS 'CVE reference data - stored once per CVE to avoid duplication';
COMMENT ON COLUMN cves.id IS 'CVE identifier (e.g., CVE-2024-1234)';


-- Workload Vulnerabilities Table
-- Tracking table linking workloads to CVEs with SLA data
CREATE TABLE workload_vulnerabilities (
    id SERIAL PRIMARY KEY,
    
    -- Team context
    team_slug VARCHAR(100) NOT NULL,
    team_slack_channel VARCHAR(100),
    
    -- Workload (application/job) context
    app_nais_id VARCHAR(255) NOT NULL,
    app_name VARCHAR(255) NOT NULL,
    app_workload_type VARCHAR(20) NOT NULL,
    app_environment VARCHAR(100),
    app_repository VARCHAR(500),
    app_image_name VARCHAR(500),
    app_image_tag VARCHAR(255),
    app_has_external_ingress BOOLEAN DEFAULT FALSE,
    app_ingress_types JSONB,
    
    -- CVE reference
    cve_id VARCHAR(20) NOT NULL REFERENCES cves(id),
    package_name VARCHAR(255),
    
    -- Tracking
    suppressed BOOLEAN DEFAULT FALSE,
    discovered_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_seen_at TIMESTAMP NOT NULL DEFAULT NOW(),
    resolved_at TIMESTAMP,
    sync_timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(app_nais_id, cve_id, package_name)
);

-- Essential indexes only (5 total)
-- Minimal set to support core queries without over-engineering

-- CVEs table
CREATE INDEX idx_cves_severity ON cves(severity);

-- Core query patterns
CREATE INDEX idx_wv_team_slug ON workload_vulnerabilities(team_slug);
CREATE INDEX idx_wv_cve_id ON workload_vulnerabilities(cve_id); -- FK for JOINs and orphan cleanup

-- Filter active vulnerabilities
CREATE INDEX idx_wv_active_vulns ON workload_vulnerabilities(resolved_at) 
    WHERE resolved_at IS NULL;

-- Sync cleanup
CREATE INDEX idx_wv_sync_cleanup ON workload_vulnerabilities(team_slug, sync_timestamp);

COMMENT ON TABLE workload_vulnerabilities IS 'Vulnerability tracking for workloads - normalized with CVE data in separate table';
COMMENT ON COLUMN workload_vulnerabilities.cve_id IS 'Foreign key to cves table';
COMMENT ON COLUMN workload_vulnerabilities.sync_timestamp IS 'Timestamp when this row was last synced - used for cleanup';
COMMENT ON COLUMN workload_vulnerabilities.discovered_at IS 'First time this CVE was seen on this workload (for SLA tracking)';
COMMENT ON COLUMN workload_vulnerabilities.last_seen_at IS 'Most recent sync where this CVE was present';
COMMENT ON COLUMN workload_vulnerabilities.resolved_at IS 'When CVE was resolved (NULL = still active)';
