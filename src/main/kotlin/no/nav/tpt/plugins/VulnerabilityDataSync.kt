package no.nav.tpt.plugins

import io.ktor.server.application.*
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import org.slf4j.LoggerFactory
import kotlin.time.Duration.Companion.hours
import kotlin.time.Duration.Companion.minutes
import kotlin.time.Duration.Companion.seconds

fun Application.configureVulnerabilityDataSync() {
    val logger = LoggerFactory.getLogger("VulnerabilityDataSync")
    val syncJob = dependencies.vulnerabilityDataSyncJob
    val leaderElection = dependencies.leaderElection

    // Start leader election checks
    leaderElection.startLeaderElectionChecks(this)

    val syncIntervalHours: Long = 6L

    logger.info("Vulnerability data sync scheduler configured: interval=${syncIntervalHours}h, initial delay=${syncIntervalHours}")

    launch {
        delay(syncIntervalHours.hours)

        while (true) {
            delay(30.seconds)
            try {
                val isLeader = leaderElection.isLeader()
                if (isLeader) {
                    logger.info("This pod is the leader - starting scheduled vulnerability data sync")
                    syncJob.syncAllTeams()
                    logger.info("Scheduled vulnerability data sync completed")
                } else {
                    logger.info("This pod is not the leader - skipping sync. Next check in ${syncIntervalHours} hours")
                }
            } catch (e: Exception) {
                logger.error("Scheduled vulnerability data sync failed", e)
            }
        }
    }

    logger.info("Vulnerability data sync scheduler started with Kubernetes leader election")
}
