package no.nav.tpt.domain.vulnerability

import java.time.Instant

interface VulnerabilityRepository {
    suspend fun upsertVulnerability(vulnerability: VulnerabilityTrackingData): VulnerabilityTrackingData

    suspend fun getActiveVulnerabilitiesForTeams(teamSlugs: List<String>): List<VulnerabilitySearchResult>
    
    suspend fun deleteOldDataForTeam(teamSlug: String, beforeTimestamp: Instant): Int
    
    suspend fun getTeamVulnerabilityCounts(): List<TeamVulnerabilityCount>
    
    suspend fun getTeamSlaSummaries(): List<TeamSlaSummary>
    
    suspend fun getTeamSlaDetails(teamSlugs: List<String>): List<TeamSlaDetails>
}

data class VulnerabilitySearchResult(
    val cveId: String,
    val teamSlug: String,
    val applicationName: String,
    val applicationNaisId: String,
    val workloadType: String,
    val environment: String?,
    val repository: String?,
    val imageTag: String?,
    val ingressTypes: List<String>,
    val packageName: String?,
    val severity: String?,
    val description: String?,
    val vulnerabilityDetailsLink: String?,
    val hasExternalIngress: Boolean,
    val suppressed: Boolean,
    val discoveredAt: Instant,
    val lastSeenAt: Instant
)

data class TeamVulnerabilityCount(
    val teamSlug: String,
    val totalCount: Int,
    val criticalCount: Int,
    val highCount: Int,
    val mediumCount: Int,
    val lowCount: Int,
    val unknownCount: Int
)

data class TeamSlaSummary(
    val teamSlug: String,
    val totalVulnerabilities: Int,
    val criticalOverdue: Int,
    val criticalWithinSla: Int,
    val nonCriticalOverdue: Int,
    val nonCriticalWithinSla: Int,
    val repositoriesOutOfSla: Int,
    val maxDaysOverdue: Long
)

data class TeamSlaDetails(
    val teamSlug: String,
    val totalVulnerabilities: Int,
    val criticalOverdue: Int,
    val criticalWithinSla: Int,
    val nonCriticalOverdue: Int,
    val nonCriticalWithinSla: Int,
    val repositoriesOutOfSla: Int,
    val maxDaysOverdue: Long,
    val criticalOverdueItems: List<SlaOverdueItem>,
    val nonCriticalOverdueItems: List<SlaOverdueItem>
)

data class SlaOverdueItem(
    val cveId: String,
    val applicationName: String,
    val severity: String?,
    val discoveredAt: Instant,
    val daysOverdue: Long
)

