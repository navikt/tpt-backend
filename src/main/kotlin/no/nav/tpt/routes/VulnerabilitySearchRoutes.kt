package no.nav.tpt.routes

import io.ktor.http.*
import io.ktor.server.application.*
import io.ktor.server.auth.authenticate
import io.ktor.server.auth.principal
import io.ktor.server.response.*
import io.ktor.server.routing.*
import no.nav.tpt.plugins.BadRequestException
import no.nav.tpt.plugins.InternalServerException
import no.nav.tpt.plugins.TokenPrincipal
import no.nav.tpt.plugins.dependencies

fun Route.vulnerabilitySearchRoutes() {
    authenticate("auth-bearer") {
        get("/sla/overdue") {
            val principal = call.principal<TokenPrincipal>()!!
            val email = principal.preferredUsername
                ?: throw BadRequestException("preferred_username claim not found in token")

            try {
                val userContextService = call.dependencies.userContextService
                val vulnerabilitySearchService = call.dependencies.vulnerabilitySearchService
                
                val userContext = userContextService.getUserContext(email, principal.groups)
                
                val response = vulnerabilitySearchService.getOverdueSlaReport(userContext.teams)
                call.respond(HttpStatusCode.OK, response)
            } catch (e: Exception) {
                throw InternalServerException("Failed to generate SLA report", e)
            }
        }
    }
}
